name: Verify PR

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch
on:
  pull_request:
    branches: [ main ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.17

      - name: Build
        run: go build -v ./...

      - name: Test
        run: go test -v ./...

  verifyDeploy:
    needs: verify
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.17

      - name: Build
        run: |
          mkdir -p "terraform.d/plugins/registry.terraform.io/cloud-native-toolkit/gitops"
          OUTPUT_DIR=$(cd terraform.d/plugins/registry.terraform.io/cloud-native-toolkit/gitops; pwd -P)
          
          go build -o terraform-provider-gitops
          
          mkdir tmp
          mv ./terraform-provider-gitops tmp/terraform-provider-gitops_v0.0.0
          cp README.md tmp/
          
          cd tmp
          zip "${OUTPUT_DIR}/terraform-provider-gitops_0.0.0_linux_amd64.zip" *
          cd ..
          
          ls "${OUTPUT_DIR}"

      - name: Set up terraform cli
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.2.8

      - name: Apply terraform
        env:
          TF_VAR_git_host: github.com
          TF_VAR_git_org: cloud-native-toolkit-test
          TF_VAR_git_username: ${{ secrets.GIT_ADMIN_USERNAME }}
          TF_VAR_git_token: ${{ secrets.GIT_ADMIN_TOKEN }}
          TF_LOG_PROVIDER: INFO
          TF_LOG: DEBUG
        run: |
          cd examples
          terraform init || exit 1
          terraform apply -auto-approve

  verifyAll:
    needs: verifyDeploy
    runs-on: ubuntu-latest

    steps:
      - run: echo "Success"
